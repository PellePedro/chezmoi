{{- if eq .chezmoi.osRelease.id "arch" -}}
#!/bin/bash

set -eufo pipefail

log() {
  printf "[CHEZMOI] %s\n" "$@"
}

# Update package database
log "Updating package database..."
sudo pacman -Sy

# Essential packages from scripts/install-packages.sh
{{ $packages := list
    "curl"
    "wget"
    "git"
    "jq"
    "gnu-netcat"
    "socat"
    "ripgrep"
    "zsh"
    "tmux"
    "htop"
    "tree"
    "nnn"
    "fd"
    "bat"
    "base-devel"
    "protobuf"
    "cmake"
    "pkgconf"
    "sqlite"
    "net-tools"
    "bind"
    "iputils"
    "iproute2"
    "nmap"
    "python-pip"
    "unzip"
    "zip"
    "libtool"
    "autoconf"
    "automake"
    "gzip"
    "tar"
-}}

log "Installing Arch packages..."
sudo pacman -S --needed --noconfirm {{ $packages | join " " }}

# Install yay (AUR helper) if not present
if ! command -v yay &> /dev/null; then
  log "Installing yay (AUR helper)..."
  cd /tmp
  git clone https://aur.archlinux.org/yay.git
  cd yay
  makepkg -si --noconfirm
  cd ..
  rm -rf yay
fi

# Install Homebrew if not present
if ! command -v brew &> /dev/null; then
  log "Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi

# Homebrew packages
{{ $brews := list
    "fzf"
    "eza"
    "dust"
    "git-delta"
    "gh"
    "lazygit"
    "k9s"
    "just"
    "zoxide"
    "shellcheck"
    "shfmt"
    "yq"
    "watch"
    "pspg"
    "zellij"
    "starship"
-}}

log "Installing Homebrew packages..."
{{ range ($brews | sortAlpha | uniq) -}}
if ! brew list --formula "{{ . }}" &>/dev/null; then
  log "Installing {{ . }}..."
  brew install "{{ . }}" || echo "Warning: Failed to install {{ . }}"
fi
{{ end -}}

# Install Go if not present
if ! command -v go &> /dev/null; then
  log "Installing Go..."
  GO_VERSION="1.23.4"
  {{ if eq .chezmoi.arch "arm64" -}}
  GO_ARCH="linux-arm64"
  {{ else }}
  GO_ARCH="linux-amd64"
  {{ end -}}
  curl -fsSL "https://dl.google.com/go/go${GO_VERSION}.${GO_ARCH}.tar.gz" -o /tmp/golang.tar.gz
  sudo rm -rf /usr/local/go
  sudo tar -C /usr/local -xzf /tmp/golang.tar.gz
  rm /tmp/golang.tar.gz
  sudo ln -sf /usr/local/go/bin/go /usr/local/bin/go
  sudo ln -sf /usr/local/go/bin/gofmt /usr/local/bin/gofmt
fi

# Install chezmoi specific tools
{{ $chezmoi_tools := list
    "age"
    "gopass"
-}}

log "Installing chezmoi tools..."
{{ range ($chezmoi_tools | sortAlpha | uniq) -}}
if ! command -v "{{ . }}" &> /dev/null; then
  log "Installing {{ . }}..."
  brew install "{{ . }}" || echo "Warning: Failed to install {{ . }}"
fi
{{ end -}}

log "Arch Linux package installation completed!"
{{- end -}}