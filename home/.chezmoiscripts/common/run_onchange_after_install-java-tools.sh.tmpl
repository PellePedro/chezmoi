#!/bin/bash

set -eufo pipefail

log() {
  printf "[CHEZMOI] %s\n" "$@"
}

# Check if SDKMAN is installed
if [ ! -d "$HOME/.sdkman" ]; then
  log "SDKMAN not found. Please install SDKMAN first."
  exit 0
fi

log "Configuring SDKMAN and installing Java tools..."

# Source SDKMAN
export SDKMAN_DIR="$HOME/.sdkman"
[[ -s "$SDKMAN_DIR/bin/sdkman-init.sh" ]] && source "$SDKMAN_DIR/bin/sdkman-init.sh"

# Configure SDKMAN for non-interactive use
if [ -f "$SDKMAN_DIR/etc/config" ]; then
  sed -i.bak 's/sdkman_auto_answer=false/sdkman_auto_answer=true/g' "$SDKMAN_DIR/etc/config" || true
fi

# Install Java if not present
if ! sdk list java | grep -q ">>>" 2>/dev/null; then
  log "Installing Java..."
  sdk install java 21.0.5-ms || sdk install java 21-open || true
fi

# Install Maven if not present
if ! command -v mvn &> /dev/null; then
  log "Installing Maven..."
  sdk install maven || true
fi

# Install Gradle if not present
if ! command -v gradle &> /dev/null; then
  log "Installing Gradle..."
  sdk install gradle || true
fi

log "Java tools installation completed!"

# Verify installations
log "Verifying Java tools:"
echo "========================="
java -version 2>&1 | head -1 || echo "✗ Java not found"
mvn -version 2>&1 | head -1 || echo "✗ Maven not found"
gradle -version 2>&1 | grep "Gradle" || echo "✗ Gradle not found"